"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _react=_interopRequireDefault(require("react")),_components=require("@sanity/base/components"),_PatchEvent=_interopRequireWildcard(require("@sanity/form-builder/PatchEvent")),_autoId=require("@reach/auto-id"),_creatable=_interopRequireDefault(require("react-select/creatable")),_reactSelect=_interopRequireDefault(require("react-select")),_formBuilder=require("part:@sanity/form-builder"),_select=_interopRequireDefault(require("part:tags/components/select")),_client=_interopRequireDefault(require("part:@sanity/base/client")),_rxjs=require("rxjs"),_operators=require("rxjs/operators"),_ui=require("@sanity/ui");function _getRequireWildcardCache(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(_getRequireWildcardCache=function(a){return a?c:b})(a)}function _interopRequireWildcard(a,b){if(!b&&a&&a.__esModule)return a;if(null===a||"object"!=typeof a&&"function"!=typeof a)return{default:a};var c=_getRequireWildcardCache(b);if(c&&c.has(a))return c.get(a);var d={},e=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var f in a)if("default"!=f&&Object.prototype.hasOwnProperty.call(a,f)){var g=e?Object.getOwnPropertyDescriptor(a,f):null;g&&(g.get||g.set)?Object.defineProperty(d,f,g):d[f]=a[f]}return d.default=a,c&&c.set(a,d),d}function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(a,b){var c=null==a?null:"undefined"!=typeof Symbol&&a[Symbol.iterator]||a["@@iterator"];if(null!=c){var d,e,f=[],g=!0,h=!1;try{for(c=c.call(a);!(g=(d=c.next()).done)&&(f.push(d.value),!(b&&f.length===b));g=!0);}catch(a){h=!0,e=a}finally{try{g||null==c["return"]||c["return"]()}finally{if(h)throw e}}return f}}function _arrayWithHoles(a){if(Array.isArray(a))return a}function _createForOfIteratorHelper(a,b){var c="undefined"!=typeof Symbol&&a[Symbol.iterator]||a["@@iterator"];if(!c){if(Array.isArray(a)||(c=_unsupportedIterableToArray(a))||b&&a&&"number"==typeof a.length){c&&(a=c);var d=0,e=function(){};return{s:e,n:function n(){return d>=a.length?{done:!0}:{done:!1,value:a[d++]}},e:function e(a){throw a},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var f,g=!0,h=!1;return{s:function s(){c=c.call(a)},n:function n(){var a=c.next();return g=a.done,a},e:function e(a){h=!0,f=a},f:function f(){try{g||null==c.return||c.return()}finally{if(h)throw f}}}}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}var se=Object.defineProperty,ae=Object.defineProperties,oe=Object.getOwnPropertyDescriptors,k=Object.getOwnPropertySymbols,le=Object.prototype.hasOwnProperty,ce=Object.prototype.propertyIsEnumerable,I=function(a,b,c){return b in a?se(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c},p=function(a,b){for(var c in b||(b={}))le.call(b,c)&&I(a,c,b[c]);if(k){var d,e=_createForOfIteratorHelper(k(b));try{for(e.s();!(d=e.n()).done;){var c=d.value;ce.call(b,c)&&I(a,c,b[c])}}catch(a){e.e(a)}finally{e.f()}}return a},g=function(a,b){return ae(a,oe(b))},Te=function(a){return"object"!==a.jsonType},he=function(a){return"to"in a||"of"in a&&a.of[0]&&"to"in a.of[0]},D=function(a){return a||(a=[]),a.flat(1/0).filter(function(b,c){var d=JSON.stringify({label:b.label,value:b.value});return c===a.flat(1/0).findIndex(function(a){return JSON.stringify({label:a.label,value:a.value})===d})})},W=function(a,b,c){if(!a)return c;var d,f=!1;if(Array.isArray(b)&&(f=b.slice(0)),"string"==typeof b&&(f=b.split(".")),!Array.isArray(f))throw new Error("path must be an array or a string");for(;f.length;){if(d=f.shift(),!d||!a||null===a||"object"!=typeof a||Array.isArray(a)||!(d in a))return c;a=a[d]}return a};function q(a){return"__proto__"!==a&&"constructor"!==a&&"prototype"!==a}var h=function(a,b,c){var d=!1;if(Array.isArray(b)&&(d=b.slice(0)),"string"==typeof b&&(d=b.split(".")),!Array.isArray(d))throw new Error("path must be an array or a string");var f=d.pop();if(!f)return!1;if(!q(f))throw new Error("setting of prototype values not supported");for(var g;g=d.shift();){if(!q(g))throw new Error("setting of prototype values not supported");if(!g||(g in a||(a[g]={}),a=a[g],!a||"object"!=typeof a))return!1}return a[f]=c,!0},$e=function(a){var b=a.initialLoadingOptions,c=void 0===b?{}:b,d=a.initialState,e=_react.default.useState(c),g=_slicedToArray(e,2),h=g[0],j=g[1],k=_react.default.useState(!(void 0!==d)||d),l=_slicedToArray(k,2),m=l[0],i=l[1];_react.default.useEffect(function(){var a=!1;if(Object.keys(h).length)for(var b in h)h[b]&&(a=!0);i(a)},[h]);var n=_react.default.useCallback(function(a){j(function(b){return p(p({},b),a)})},[]);return[m,h,n]},Ae=function(a){var b=a.initialState,c=void 0===b?[]:b,d=_react.default.useState(c),e=_slicedToArray(d,2),f=e[0],g=e[1],h=_react.default.useState({}),j=_slicedToArray(h,2),k=j[0],l=j[1];_react.default.useEffect(function(){var a=[];for(var b in k)Array.isArray(k[b])&&a.push(...k[b]);g(D(a))},[k]);var i=_react.default.useCallback(function(a){l(function(b){return p(p({},b),a)})},[]);return[f,k,i]},we=function(a){var b=a.customLabel,c=void 0===b?"label":b,d=a.customValue,e=void 0===d?"value":d;return function(a){return g(p({},a),{_label_temp:a.label,_value_temp:a.value,label:W(a,c),value:W(a,e)})}};function Ce(a){var b=a.customLabel,c=void 0===b?"label":b,d=a.customValue,e=void 0===d?"value":d,f=a.isReference;return function(a){if(!0===f)return{_ref:a._id,_type:"reference"};var b=g(p({},a),{label:a._label_temp,value:a._value_temp});return h(b,c,a.label),h(b,e,a.value),delete b._label_temp,delete b._value_temp,void 0===b.label&&delete b.label,void 0===b.value&&delete b.value,b}}var G=/*#__PURE__*/function(){var a=_asyncToGenerator(function*(a){var b=a.tags,c=a.customLabel,d=void 0===c?"label":c,e=a.customValue,f=void 0===e?"value":e,g=we({customLabel:d,customValue:f});if(null!=b)return Array.isArray(b)&&!b.length?[]:Array.isArray(b)&&"_ref"in b[0]&&"_type"in b[0]&&"_ref"in b[0]&&"_type"in b[0]?(yield $.fetch("*[_id in $refs]",{refs:b.map(function(a){return a._ref})})).map(g):Array.isArray(b)?b.map(g):"_ref"in b&&"_type"in b?g(yield $.fetch("*[_id == $ref][0]",{ref:b._ref})):g(b)});return function(){return a.apply(this,arguments)}}(),Se=/*#__PURE__*/function(){var a=_asyncToGenerator(function*(a){var b=yield G(a);return void 0===b?[]:Array.isArray(b)?b:[b]});return function(){return a.apply(this,arguments)}}();function Oe(a){var b=a.tags,c=a.customLabel,d=void 0===c?"label":c,f=a.customValue,g=void 0===f?"value":f,h=a.isMulti,j=a.isReference,i=Ce({customLabel:d,customValue:g,isReference:j});if(void 0!==b)return h?(Array.isArray(b)||(b=[b]),b.map(i)):(Array.isArray(b)&&(b=b[0]),i(b))}var S=function(a){var b=a.customLabel,c=void 0===b?"label":b,d=a.customValue,e=void 0===d?"value":d;return(0,_rxjs.pipe)((0,_operators.map)(function(a){return Array.isArray(a)?a.flat(1/0):a}),(0,_operators.switchMap)(function(a){return Se({tags:a,customLabel:c,customValue:e})}),(0,_operators.map)(function(a){return D(a)}))},J=function(a){var b=a.query,c=a.params,d=a.customLabel,e=void 0===d?"label":d,f=a.customValue,g=void 0===f?"value":f;return $.listen(b,c,ke).pipe((0,_operators.switchMap)(function(){return $.fetch(b,c)}),S({customLabel:e,customValue:g}))};function Ee(a){var b=a.tags,c=a.isMulti,d=a.customLabel,e=void 0===d?"label":d,f=a.customValue,g=void 0===f?"value":f,h=/*#__PURE__*/function(){var a=_asyncToGenerator(function*(){return b});return function(){return a.apply(this,arguments)}}();return(0,_rxjs.defer)(function(){return(0,_rxjs.from)(h())}).pipe(S({customLabel:e,customValue:g}),(0,_operators.map)(function(a){return c?a:a[0]}))}var Re=/*#__PURE__*/function(){var a=_asyncToGenerator(function*(a){var b=yield a();return Array.isArray(b)?b:[b]});return function(){return a.apply(this,arguments)}}(),Le=function(a){var b=a.predefinedTags,c=a.customLabel,d=void 0===c?"label":c,e=a.customValue,f=void 0===e?"value":e,g=b instanceof Function?b:/*#__PURE__*/_asyncToGenerator(function*(){return b});return(0,_rxjs.defer)(function(){return(0,_rxjs.from)(Re(g)).pipe(S({customLabel:d,customValue:f}))})},Fe=function(a){var b=a.document,c=a.customLabel,d=void 0===c?"label":c,e=a.customValue,f=void 0===e?"value":e,g={document:b,customLabel:d.split(".")[0],customValue:f.split(".")[0]};return J({query:"\n  *[ _type == $document && defined(@[$customLabel]) && defined(@[$customValue])] {\n    _id,\n    \"value\": @[$customValue],\n    \"label\": @[$customLabel]\n  }\n  ",params:g,customLabel:d,customValue:f})},Pe=function(a){var b=a.document,c=a.field,d=a.isMulti,e=a.customLabel,g=void 0===e?"label":e,h=a.customValue,j=void 0===h?"value":h,i={document:b,field:c,isMulti:d,customLabel:g.split(".")[0],customValue:j.split(".")[0]};return J({query:"\n  *[\n    _type == $document &&\n    defined(@[$field]) &&\n    defined(@[$field][]) == $isMulti &&\n    (\n      (!$isMulti && defined(@[$field]->[$customLabel]) && defined(@[$field]->[$customValue])) ||\n      (!$isMulti && defined(@[$field][$customLabel]) && defined(@[$field][$customValue])) ||\n      ($isMulti && defined(@[$field][]->[$customLabel]) && defined(@[$field][]->[$customValue])) ||\n      ($isMulti && defined(@[$field][][$customLabel]) && defined(@[$field][][$customValue]))\n    ) \n  ][$field]\n  ",params:i,customLabel:g,customValue:j})},$=_client.default.withConfig({apiVersion:"2022-03-28"}),ke={includeResult:!1,includePreviousRevision:!1,visibility:"query",events:["welcome","mutation","reconnect"]},Ie=function(){return/*#__PURE__*/_react.default.createElement(_ui.Card,{padding:[3,3,4],marginBottom:[3,3,4],radius:2,shadow:1,tone:"caution"},"Tag References cannot be created inline. Please set the ",/*#__PURE__*/_react.default.createElement("code",null,"allowCreate")," option explicitly to ",/*#__PURE__*/_react.default.createElement("code",null,"false")," to remove this warning message.")},Me=function(){return/*#__PURE__*/_react.default.createElement(_ui.Card,{padding:[3,3,4],marginBottom:[3,3,4],radius:2,shadow:1,tone:"caution"},"Tag References cannot have predefined tags. Please unset the ",/*#__PURE__*/_react.default.createElement("code",null,"predefinedTags")," option to remove this warning message.")},Qe=(0,_formBuilder.withDocument)(/*#__PURE__*/_react.default.forwardRef(function(a,b){var e=_react.default.useState(void 0),k=_slicedToArray(e,2),q=k[0],r=k[1],l=$e({}),n=_slicedToArray(l,3),o=n[0],i=n[2],s=Ae({}),t=_slicedToArray(s,3),x=t[0],f=t[2],c=a.type,u=a.value,y=a.readOnly,z=a.markers,B=a.presence,C=a.onFocus,D=a.onBlur,H=a.onChange,A=a.document,I=Te(c),v=he(c),J=c.options?c.options:{},K=J.predefinedTags,M=void 0===K?[]:K,N=J.includeFromReference,Q=void 0!==N&&N,O=J.includeFromRelated,S=void 0!==O&&O,E=J.customLabel,U=void 0===E?"label":E,d=J.customValue,V=void 0===d?"value":d,m=J.allowCreate,P=!(void 0!==m)||m,R=J.onCreate,T=void 0===R?/*#__PURE__*/function(){var a=_asyncToGenerator(function*(a){var b={};return h(b,U,a),h(b,V,a),b});return function(){return a.apply(this,arguments)}}():R,j=J.checkValid,W=void 0===j?function(a,b){return!b.includes(a)&&!!a&&a.trim()===a}:j,X=J.reactSelectOptions,Y=void 0===X?{}:X,Z=c.options&&P&&v,$=c.options&&!!c.options.predefinedTags&&v;_react.default.useEffect(function(){var a={unsubscribe:function unsubscribe(){}},c=a,d=a,e=a,g=a;return i({selectedTags:!0,predefinedTags:!0,referenceTags:!0,relatedTags:!0}),c=Ee({tags:u,customLabel:U,customValue:V,isMulti:I}).subscribe(function(a){r(a),i({selectedTags:!1})}),d=Le({predefinedTags:M,customLabel:U,customValue:V}).subscribe(function(a){f({predefinedTags:a}),i({predefinedTags:!1})}),"string"==typeof Q?g=Fe({document:Q,customLabel:U,customValue:V}).subscribe(function(a){f({referenceTags:a}),i({referenceTags:!1})}):i({referenceTags:!1}),"string"==typeof S?e=Pe({document:A._type,field:S,isMulti:I,customLabel:U,customValue:V}).subscribe(function(a){f({relatedTags:a}),i({relatedTags:!1})}):i({relatedTags:!1}),function(){c.unsubscribe(),d.unsubscribe(),e.unsubscribe(),g.unsubscribe()}},[]);var _=_react.default.useCallback(/*#__PURE__*/function(){var a=_asyncToGenerator(function*(a){i({handleCreate:!0});var b=yield G({customLabel:U,customValue:V,tags:yield T(a)});Array.isArray(q)?aa([...q,b]):aa(b),i({handleCreate:!1})});return function(){return a.apply(this,arguments)}}(),[H,q]),aa=_react.default.useCallback(function(a){r(a);var b=Oe({tags:a,customLabel:U,customValue:V,isMulti:I,isReference:v});H(_PatchEvent.default.from(b?(0,_PatchEvent.set)(b):(0,_PatchEvent.unset)(b)))},[H]),w=(0,_autoId.useId)(),L=p({isLoading:o,onFocus:C,onBlur:D,ref:b,inputId:w,isMulti:I,options:x,value:q,isValidNewOption:function isValidNewOption(a,b,c){return W(a,[...c.map(function(a){return a.value}),...b.map(function(a){return a.value})])},onCreateOption:_,onChange:aa,isDisabled:y||o},Y);return/*#__PURE__*/_react.default.createElement(_components.FormField,{description:c.description,title:c.title,__unstable_markers:z,__unstable_presence:B,inputId:w},Z&&/*#__PURE__*/_react.default.createElement(Ie,null),$&&/*#__PURE__*/_react.default.createElement(Me,null),P&&!v?/*#__PURE__*/_react.default.createElement(_creatable.default,g(p({},L),{components:_select.default})):/*#__PURE__*/_react.default.createElement(_reactSelect.default,g(p({},L),{components:_select.default})))}));exports.default=Qe;